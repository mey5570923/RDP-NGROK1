name: Windows-10-Pro-High-Speed

on:
  workflow_dispatch: # Menjalankan secara manual

jobs:
  rdp-session:
    runs-on: windows-latest
    timeout-minutes: 360 # Batas maksimal 6 jam

    steps:
      - name: 1. Download & Instalasi Ngrok
        run: |
          Invoke-WebRequest https://bin.equinox.io/c/bTs9arspBaH/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
          Expand-Archive ngrok.zip

      - name: 2. Autentikasi Ngrok
        run: |
          # Ambil token dari GitHub Secrets
          .\ngrok\ngrok.exe config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: 3. Konfigurasi Windows & Optimasi Performa
        run: |
          # Aktifkan Remote Desktop (RDP)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          # Optimasi: Set Power Plan ke High Performance agar CPU tidak dibatasi
          powercfg /s 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          
          # Optimasi RDP: Mengurangi beban visual untuk koneksi lebih lancar
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "ColorDepth" -Value 4
          Restart-Service -Name TermService -Force

      - name: 4. Buat User Administrator
        run: |
          $user = "AdminPro"
          $pass = "P@ssword99!"
          net user $user $pass /add
          net localgroup administrators $user /add
          Write-Host "âœ… User: $user | Pass: $pass"

      - name: 5. Jalankan Tunnel Ngrok (Region Asia/Singapore)
        run: |
          # Menggunakan region 'ap' (Asia Pacific) untuk latensi terendah bagi user Indonesia
          Start-Process .\ngrok\ngrok.exe -ArgumentList "tcp --region ap 3389"
          Start-Sleep -Seconds 12

      - name: 6. Dapatkan Detail Alamat RDP
        run: |
          $json = Invoke-RestMethod http://localhost:4040/api/tunnels
          $address = $json.tunnels[0].public_url
          Write-Host "`n=========================================="
          Write-Host "ðŸš€ WINDOWS 10 PRO RDP SIAP"
          Write-Host "=========================================="
          Write-Host "Alamat IP  : $address"
          Write-Host "Username   : AdminPro"
          Write-Host "Password   : P@ssword99!"
          Write-Host "Region     : Asia Pacific (Singapore)"
          Write-Host "=========================================="

      - name: 7. Menjaga Sesi (Keep Alive)
        run: |
          $startTime = Get-Date
          while ($true) {
            $elapsed = (Get-Date) - $startTime
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Durasi: $($elapsed.ToString('hh\:mm\:ss')) - Performa Stabil..."
            Start-Sleep -Seconds 300
          }
